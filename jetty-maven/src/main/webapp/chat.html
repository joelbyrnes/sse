<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script type="text/javascript" src="/js/jquery-1.7.2.min.js"></script>
    <script type='text/javascript'>

      var source;
      var counter;

      function openChannel(name) {
        source = new EventSource("/chat/channel?name=" + name);

        counter = 0;

        source.addEventListener('open', function(e) {
            // Connection was opened.
            handleData("open", "Connection opened");
        }, false);

        source.addEventListener('error', function(e) {
            writeObj(e);
            var errorMsg = "unknown"
            switch (e.target.readyState) {
                // if reconnecting
                case EventSource.CONNECTING:
                    errorMsg = 'Reconnecting...';
                    break;
                // if error was fatal
                case EventSource.CLOSED:
                    // Connection was closed.
                    errorMsg = "Connection closed";
                    break;
            }
            handleData("error", errorMsg);
        }, false);

        source.onmessage = function(event) {
            //alert("onmessage");
            handleData("onmessage", event.data);
        };

        function handleData(eventName, data) {
            var tbody = document.getElementById('numbers').tBodies[0];

            var tr = tbody.insertRow(0);

            var counterTd = tr.insertCell(0);

            counterTd.innerHTML = counter++;

            var eventTd = tr.insertCell(1);

            eventTd.innerHTML = eventName;

            var randomTd = tr.insertCell(2);

            randomTd.innerHTML = data;

//        document.getElementById("result").innerHTML+=event.data + "<br>";
        }

        function writeObj(obj, message) {
            if (!message) {
                message = obj;
            }
            var details = "*****************" + "\n" + message + "\n";
            var fieldContents;
            for (var field in obj) {
                fieldContents = obj[field];
                if (typeof(fieldContents) == "function") {
                    fieldContents = "(function)";
                }
                details += "  " + field + ": " + fieldContents + "\n";
            }
            console.log(details);
        }
      }

    function send(name, message) {
        data = {"name": name, "message": message};
        $.post("/chat/send", data);
        // TODO handle failure, retry?
    }

    </script>
    <title>Simple chat channel using HTML5 Server-Side Events</title>
</head>
<body>
Chat<br/>

<form method="GET" action="/chat">
    <input id="username" type="text" name="name">
    <input type="submit" value="Connect" onclick="openChannel(getElementById('username').value); return false;">
</form>
<br/>

<form method="POST" action="/chat/send">
    <input id="message" type="text" name="message">
    <input type="submit" value="Send" onclick="send(getElementById('username').value, getElementById('message').value); return false;">
</form>

<div id="result"></div>

<table id="numbers" border="1">
    <tbody/>
</table>
</body>
</html>